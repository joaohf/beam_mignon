<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>riemann echo | BEAM Mignon</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Detalhes sobre a implementação de um servidor riemann"><meta name=generator content="Hugo 0.105.0-DEV"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="riemann echo"><meta property="og:description" content="Detalhes sobre a implementação de um servidor riemann"><meta property="og:type" content="article"><meta property="og:url" content="https://beam-mignon.netlify.app/posts/mignon-26/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-26T22:43:50+02:00"><meta property="article:modified_time" content="2020-07-28T20:43:54+02:00"><meta property="og:see_also" content="https://beam-mignon.netlify.app/posts/mignon-29/"><meta itemprop=name content="riemann echo"><meta itemprop=description content="Detalhes sobre a implementação de um servidor riemann"><meta itemprop=datePublished content="2020-07-26T22:43:50+02:00"><meta itemprop=dateModified content="2020-07-28T20:43:54+02:00"><meta itemprop=wordCount content="2690"><meta itemprop=keywords content="code,parser,tcp,udp,gen_statem,"><meta name=twitter:card content="summary"><meta name=twitter:title content="riemann echo"><meta name=twitter:description content="Detalhes sobre a implementação de um servidor riemann"></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://beam-mignon.netlify.app/images/featured/26.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">BEAM Mignon</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/contact/ title="Contato page">Contato</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Posts page">Posts</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/reference/ title="Referencias page">Referencias</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Sobre page">Sobre</a></li></ul><div class=ananke-socials><a href=https://twitter.com/joaohf target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/joaohf/ target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jo%c3%a3o-henrique-freitas target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://beam-mignon.netlify.app/feed.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">riemann echo</h1><h2 class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">Detalhes sobre a implementação de um servidor riemann</h2></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"><a href="https://twitter.com/share?url=https://beam-mignon.netlify.app/posts/mignon-26/&text=riemann%20echo" class="ananke-social-link twitter no-underline" aria-label="share on Twitter"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://beam-mignon.netlify.app/posts/mignon-26/&title=riemann%20echo" class="ananke-social-link linkedin no-underline" aria-label="share on LinkedIn"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div><h1 class="f1 athelas mt3 mb1">riemann echo</h1><time class="f6 mv4 dib tracked" datetime=2020-07-26T22:43:50+02:00>julho 26, 2020</time>
<span class="f6 mv4 dib tracked">- 13 minutes read</span>
<span class="f6 mv4 dib tracked">- 2690 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Vamos detalhar algumas características bem interessante utilizadas na implementação de um servidor riemann chamado katja_echo.</p><h2 id=riemannio>riemann.io</h2><p><a href=http://riemann.io/>riemann.io</a> é um servidor para processamento de stream de eventos, capaz de aplicar funções específicas para cada evento recebido e agregar ou gerar outros eventos para sistemas externos, escrito em Clojure e roda usando a JVM.</p><p>riemann pode ser utilizado para processar métricas onde aplicações instrumentadas enviam para um servidor central métricas relacionadas com algo importante ocorrido. Este modelo se chama <code>push metrics</code>.</p><p>Atualmente pode não ser a solução de métricas mais conhecida no momento mas é uma opção a ser considerada dependendo dos casos de uso. Veja mais informações no site do projeto.</p><p>Existem algumas bibliotecas cliente para Elixir e Erlang:</p><ul><li><a href=https://hex.pm/packages/riemannx>riemannx</a></li><li><a href=https://hex.pm/packages/katja>katja</a></li></ul><p>Bem como plugin para o framework <a href=https://hex.pm/packages/telemetry>telemetry</a>, <a href=https://hex.pm/packages/telemetry_metrics_riemann>telemetry_metrics_riemann</a>.</p><p>No entanto, nosso foco é no seguinte cenário:</p><blockquote><p>Imagine que temos uma aplicação instrumentada para enviar métricas para um servidor riemann usando conexão TCP ou UDP. E durante os testes unitários e integração a nossa aplicação tenta fazer uma conexão com o servidor riemann para enviar as métricas. No entanto como não temos um servidor iniciado a aplicação falha em tentar fazer a conexão e enviar as métricas.</p></blockquote><p>Claro que o cenário acima é hipotético e pode ser resolvido de outras formas como por exemplo utilizando o <em>telemetry</em> ou configurando a aplicação para não enviar métricas durante testes ou implementando algum servidor no qual imita o comportamento de um servidor real riemann.</p><p>Já trabalhei em alguns projetos nos quais havia um <em>docker compose</em> apenas para subir a infraestrutura local (contento JVM e riemann) quando executávamos testes unitários. Os testes eram executados e no final destruíamos todo o ambiente do <em>docker compose</em>.</p><p>Recentemente criei uma aplicação chamada <a href=https://github.com/katja-beam/katja_echo>katja_echo</a> justamente para implementar uma imitação de um servidor riemann no qual recebe eventos utilizando TCP ou UDP, armazena cada evento e responde alguma eventual consulta dos eventos armazenados.</p><p>Neste pull request <a href=https://github.com/katja-beam/katja_vmstats/pull/6>Introduce katja_echo when running integration tests</a> podemos ver uma aplicação mais prática. <a href=https://github.com/katja-beam/katja_vmstats>katja_vmstats</a> é uma aplicação Erlang no qual faz uma leitura de várias estatísticas da BEAM VM e envia para um servidor riemann. Os testes de integração do projeto precisava de um servidor riemann ativo. Utilizando a aplicação <em>katja_echo</em> durante os testes não é mais necessário conviver com o overhead de instanciar uma JVM e riemann.</p><p>Então este artigo vai discutir alguns detalhes de implementação do projeto katja_echo nos quais foram bastante interessantes do ponto de vista dos recursos utilizados do OTP.</p><h2 id=o-protocolo-riemann>O protocolo riemann</h2><p>Vamos começar pelo <a href=http://riemann.io/concepts.html>protocolo riemann</a>, no qual é muito simples. Basicamente cada evento é um conjunto de campos obrigatórios e opcionais:</p><ul><li>host: &ldquo;api1&rdquo;</li><li>service: &ldquo;HTTP reqs/sec&rdquo;</li><li>state: &ldquo;ok&rdquo;</li><li>time: in unix epoch</li><li>description</li><li>tags: [&ldquo;rate&rdquo;, &ldquo;xyz&rdquo;]</li><li>metric: numero</li><li>ttl: valor indicando quando este evento deve ser considerado expirado</li></ul><p>Estes campos são serializados utilizando <a href=https://developers.google.com/protocol-buffers>Google Protocol Buffers</a> e especificados no arquivo <a href=https://github.com/riemann/riemann-java-client/blob/master/riemann-java-client/src/main/proto/riemann/proto.proto>proto.proto</a> no é gerado código para criar as funções de encode e decode.</p><p>Sendo que uma mensagem no formato riemann é descrita assim:</p><small>Protocolo riemann
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/proto/katja_echo.proto title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/proto/katja_echo.proto source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/proto/katja_echo.proto<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>message RiemannPB_Msg {
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  optional bool ok <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  optional string error <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  repeated RiemannPB_State states <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  optional RiemannPB_Query <span style=color:#66d9ef>query</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  repeated RiemannPB_Event events <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}</span></span></code></pre></div></div><p>Podendo conter um <code>Event</code>, <code>Query</code>, <code>State</code>.</p><p>Projetos em Erlang/Elixir possuem suporte para criar encoders e decoders para protocol buffers. Exemplo: utilizando o plugin <a href=https://hex.pm/packages/rebar3_gpb_plugin title="Package rebar3_gpb_plugin" target=_blank>rebar3_gpb_plugin</a>
e adicionando a dependência <a href=https://hex.pm/packages/gpb title="Package gpb" target=_blank>gpb</a>
as funcões de encode e decode são criadas automaticamente:</p><small>Encoder/Decoder
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_pb.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_pb.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_pb.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#75715e>%% -*- coding: utf-8 -*-
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#75715e>%% @private
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#75715e>%% Automatically generated, do not edit
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#75715e>%% Generated by gpb_compile version 4.10.5
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#75715e></span>-module(katja_echo_pb).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>-export([encode_msg<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>, encode_msg<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>, encode_msg<span style=color:#f92672>/</span><span style=color:#ae81ff>3</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>-export([encode<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]). <span style=color:#75715e>%% epb compatibility
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#75715e></span>-export([encode_riemannpb_state<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>-export([encode_riemannpb_event<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>-export([encode_riemannpb_query<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>-export([encode_riemannpb_msg<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>-export([encode_riemannpb_attribute<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>-export([decode_msg<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>, decode_msg<span style=color:#f92672>/</span><span style=color:#ae81ff>3</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>-export([decode<span style=color:#f92672>/</span><span style=color:#ae81ff>2</span>]). <span style=color:#75715e>%% epb compatibility
</span></span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span><span style=color:#75715e></span>-export([decode_riemannpb_state<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>-export([decode_riemannpb_event<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>-export([decode_riemannpb_query<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>-export([decode_riemannpb_msg<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>-export([decode_riemannpb_attribute<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>]).</span></span></code></pre></div></div><p>O plugin rebar3_gpb_plugin suporta algumas configurações definidas no arquivo <em>rebar.config</em>. Dependendo do caso, pode ser necessário alterar:</p><small>Encoder/Decoder
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/rebar.config title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/rebar.config source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/rebar.config<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{gpb_opts, [
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>  {i, <span style=color:#e6db74>&#34;proto&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>  {module_name_suffix, <span style=color:#e6db74>&#34;_pb&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>  {o_erl, <span style=color:#e6db74>&#34;src&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>  {o_hrl, <span style=color:#e6db74>&#34;include&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>  {strings_as_binaries, true},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>  type_specs,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>  epb_compatibility]}.</span></span></code></pre></div></div><p>Bom, estas funções possibilitam serializar mensagens no formato correto. Agora precisamos implementar alguns servidores (gen_statem e gen_server) para receber e enviar estas mensagens.</p><p>katja_echo suporta receber mensagens via TCP e/ou UDP.</p><h2 id=servidor-udp>Servidor UDP</h2><p>O servidor UDP, <a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl>katja_echo_udp.erl</a>, foi implementado utilizando um gen_server.</p><small>gen_server init callback
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>-spec init(Args :: list()) <span style=color:#f92672>-&gt;</span> {ok, State :: state()}.
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#a6e22e>init</span>([Opts]) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    Port <span style=color:#f92672>=</span> proplists:<span style=color:#a6e22e>get_value</span>(port, Opts),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    {ok, Socket} <span style=color:#f92672>=</span> gen_udp:<span style=color:#a6e22e>open</span>(Port, [binary, {active, true}]),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    Cbk <span style=color:#f92672>=</span> katja_echo:<span style=color:#a6e22e>callback</span>(Opts),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    {ok, #state{socket <span style=color:#f92672>=</span> Socket, callback <span style=color:#f92672>=</span> Cbk}}.</span></span></code></pre></div></div><p>A função
<a href=https://erlang.org/doc/man/gen_udp.html#open-2 title=gen_udp:open/2 target=_blank>gen_udp:open/2</a>
faz a criação do socket UDP na porta especificada. Já o segundo parâmetro especifica como queremos receber as mensagens. Escolhemos o modo ativo no qual vamos precisar implementar a callback handle_info/2 para receber os pacotes UDP.</p><p>Depois armazenamos o socket no estado do gen_server.</p><p>Usando o modo ativo, significa que o processo katja_echo_udp irá receber uma mensagem toda vez que haja um pacote recebido pelo gen_udp.</p><small>gen_server init callback
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>handle_info</span>({udp, _Socket, _IP, _InPortNo, Packet},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    #state{callback <span style=color:#f92672>=</span> Cbk, errors <span style=color:#f92672>=</span> Errors} <span style=color:#f92672>=</span> State) <span style=color:#f92672>-&gt;</span></span></span></code></pre></div></div><p>O formato da mensagem é <em>{udp, Socket, IP, InPort, Packet}</em>. Neste caso estamos interessados no quinto elemento da tupla (Packet) pois a seguinte função vai tentar decodificar o pacote recebido:</p><small>handle_info packet
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_udp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    NState <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    <span style=color:#66d9ef>case</span> katja_echo:<span style=color:#a6e22e>decode</span>(udp, Packet) <span style=color:#66d9ef>of</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        {ok, #riemannpb_msg{ok<span style=color:#f92672>=</span>true, events <span style=color:#f92672>=</span> Events}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>            ok <span style=color:#f92672>=</span> katja_echo:<span style=color:#a6e22e>events</span>(Cbk, Events),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            State;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>        {error, #riemannpb_msg{ok<span style=color:#f92672>=</span>false, error<span style=color:#f92672>=</span>Reason}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            Errors0 <span style=color:#f92672>=</span> maps:<span style=color:#a6e22e>update_with</span>(Reason, <span style=color:#66d9ef>fun</span> katja_echo:incr<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, Errors),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>            State#state{errors <span style=color:#f92672>=</span> Errors0};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        {error, Reason} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            Errors0 <span style=color:#f92672>=</span> maps:<span style=color:#a6e22e>update_with</span>(Reason, <span style=color:#66d9ef>fun</span> katja_echo:incr<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>, Errors),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            State#state{errors <span style=color:#f92672>=</span> Errors0}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    <span style=color:#66d9ef>end</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {noreply, NState};</span></span></code></pre></div></div><p>Neste caso estamos delegando para outra função
<em>katja_echo:decode/2</em>
no qual faz a diferenciação entre &lsquo;udp&rsquo; e &rsquo;tcp&rsquo;:</p><small>decode udp
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>decode</span>(udp, Msg) <span style=color:#66d9ef>when</span> is_binary(Msg) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#66d9ef>try</span> katja_echo_pb:<span style=color:#a6e22e>decode_riemannpb_msg</span>(Msg) <span style=color:#66d9ef>of</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        R <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            {ok, R#riemannpb_msg{ok<span style=color:#f92672>=</span>true}}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#66d9ef>catch</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        error:_Reason <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>            {eror, #riemannpb_msg{ok<span style=color:#f92672>=</span>false, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Response could not be decoded&#34;</span>}}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    <span style=color:#66d9ef>end</span>;</span></span></code></pre></div></div><p>Isso é necessário pois um pacote UDP (User Datagram Packet) deve conter uma mensagem riemann completa, ou seja, o decoder de proto buffer para termos Erlang deve decodificar uma mensagem ou falhar.</p><h2 id=servidor-tcp>Servidor TCP</h2><p>Também temos um servidor TCP implementado usando gen_statem. Não é muito comum pelo fato de que gen_statem é mais complexo que gen_server. Entretanto complexidade não é o caso aqui.</p><div><aside class="callout dark-gray bg-washed-green"><div class=type><svg class="large-icon"><use xlink:href="/dist/images/icons.svg#sprite-callout-tip"/></svg></div><div class=content><p>Leia mais sobre gen_statem na documentação oficial <a href=https://erlang.org/doc/design_principles/statem.html>statem</a> e logo depois o artigo <a href=https://andrealeopardi.com/posts/connection-managers-with-gen_statem/>Persistent connections with gen_statem</a> para um caso prático.</p><p>Em muitos casos usar implementar um gen_server fica mais completo do que utilizar gen_statem com uma máquina de estado definida.</p></div></aside></div><p>No caso TCP, quando recebemos um novo cliente, criamos um socket chamando a função
<a href=https://erlang.org/doc/man/gen_tcp.html#accept-1 title=gen_tcp:accept/1 target=_blank>gen_tcp:accept/1</a>
e seguimos para o próximo estado definido chamado: connected.</p><small>tcp connection
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>idle</span>(internal, establish, #state{lsocket <span style=color:#f92672>=</span> LSocket} <span style=color:#f92672>=</span> Data) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    {ok, AcceptSocket} <span style=color:#f92672>=</span> gen_tcp:<span style=color:#a6e22e>accept</span>(LSocket),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    NData <span style=color:#f92672>=</span> Data#state{socket <span style=color:#f92672>=</span> AcceptSocket},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    {next_state, connected, NData}.</span></span></code></pre></div></div><p>Quando no estado &lsquo;connected&rsquo; podemos receber mensagens enviadas pelo gen_tcp quando há alguma mensagem recebida pelo socket (exemplo: <em>{tcp, Socket, Packet}</em>).</p><small>connected state
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>connected</span>(info, {tcp, Socket, Packet}, #state{socket <span style=color:#f92672>=</span> Socket} <span style=color:#f92672>=</span> Data) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    {ok, NData} <span style=color:#f92672>=</span> process_packet(Data, Packet),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    ok <span style=color:#f92672>=</span> inet:<span style=color:#a6e22e>setopts</span>(Socket, [{active, once}]),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    {keep_state, NData};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#a6e22e>connected</span>(info, {tcp_closed, Socket}, #state{socket <span style=color:#f92672>=</span> Socket}) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {stop, normal};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#a6e22e>connected</span>(info, {tcp_error, Socket, _Reason}, #state{socket <span style=color:#f92672>=</span> Socket} <span style=color:#f92672>=</span> Data) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    ok <span style=color:#f92672>=</span> gen_tcp:<span style=color:#a6e22e>close</span>(Socket),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {stop, normal, Data#state{socket <span style=color:#f92672>=</span> undefined}}.</span></span></code></pre></div></div><p>A função
<em>process_packet/2</em>
é onde fazemos a decodificação do pacote recebido:</p><small>connected state
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>process_packet</span>(#state{socket <span style=color:#f92672>=</span> Socket, callback <span style=color:#f92672>=</span> Cbk, errors <span style=color:#f92672>=</span> Errors, data <span style=color:#f92672>=</span> Acc} <span style=color:#f92672>=</span> State,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    Packet) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    BinMsg2 <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&lt;</span>Acc<span style=color:#f92672>/</span>binary, Packet<span style=color:#f92672>/</span>binary<span style=color:#f92672>&gt;&gt;</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    <span style=color:#66d9ef>case</span> katja_echo:<span style=color:#a6e22e>decode</span>(tcp, BinMsg2) <span style=color:#66d9ef>of</span></span></span></code></pre></div></div><p>O importante desta função é que precisamos decodificar um pacote contendo o payload atual e também qualquer buffer armazenado do payload anterior ao atual. Como o protocolo TCP é um stream (não tem início e fim) temos que identificar quantos bytes irão formar uma mensagem riemann possível de ser decodificada. E o restante dos bytes, se houver, precisam ser bufferizados para concatenar com próximo pacote recebido.</p><p>Seguindo no detalhe da função
<em>process_packet/2</em>
:</p><small>connected state
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>    <span style=color:#66d9ef>case</span> katja_echo:<span style=color:#a6e22e>decode</span>(tcp, BinMsg2) <span style=color:#66d9ef>of</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>        {ok, #riemannpb_msg{ok<span style=color:#f92672>=</span>true, events <span style=color:#f92672>=</span> [], states <span style=color:#f92672>=</span> [],
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>            <span style=color:#66d9ef>query</span> <span style=color:#f92672>=</span> #riemannpb_query{string <span style=color:#f92672>=</span> Query}}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>            {ok, Results} <span style=color:#f92672>=</span> katja_echo:<span style=color:#66d9ef>query</span>(Cbk, Query),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>            send_riemann_reply(Socket, Results),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        {ok, State#state{data <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&lt;&gt;&gt;</span>}};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>            {ok, #riemannpb_msg{ok<span style=color:#f92672>=</span>true, events <span style=color:#f92672>=</span> Events}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>            send_riemann_reply(Socket),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>            ok <span style=color:#f92672>=</span> katja_echo:<span style=color:#a6e22e>events</span>(Cbk, Events),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>        {ok, State#state{data <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&lt;&gt;&gt;</span>}};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>            {error, #riemannpb_msg{ok<span style=color:#f92672>=</span>false, error<span style=color:#f92672>=</span>Reason}} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>            Errors0 <span style=color:#f92672>=</span> maps:<span style=color:#a6e22e>update_with</span>(Reason, <span style=color:#66d9ef>fun</span> katja_echo:incr<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>, Errors),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>            {ok, State#state{data <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;&lt;&gt;&gt;</span>, errors <span style=color:#f92672>=</span> Errors0}};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>        {error, Reason} <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            Errors0 <span style=color:#f92672>=</span> maps:<span style=color:#a6e22e>update_with</span>(Reason, <span style=color:#66d9ef>fun</span> katja_echo:incr<span style=color:#f92672>/</span><span style=color:#ae81ff>1</span>, Errors),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>            {ok, State#state{data <span style=color:#f92672>=</span> BinMsg2, errors <span style=color:#f92672>=</span> Errors0}}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    <span style=color:#66d9ef>end</span>.</span></span></code></pre></div></div><p>Caso ocorra algum erro na decodificação, devemos armazenar o <em>BinMsg2</em> no estado. Pois a próxima vez que recebermos um novo pacote TCP, iremos fazer um append desta forma: <em>BinMsg2 = &#171;Acc/binary, Packet/binary&#187;,</em> e tentar decodificar novamente a mensagem.</p><p>Os outros branches do <em>case</em> acima fazem o tratamento quando a mensagem riemann é um evento ou uma query.</p><p>Para decodificar um pacote TCP recebido com sucesso, primeiro temos que verificar se o pacote se parece com uma mensagem riemann aplicando um functional pattern match no segundo parâmetro:</p><small>decode udp
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>decode</span>(tcp, <span style=color:#f92672>&lt;&lt;</span>MsgSize:<span style=color:#ae81ff>32</span><span style=color:#f92672>/</span>integer<span style=color:#f92672>-</span>big, Msg<span style=color:#f92672>/</span>binary<span style=color:#f92672>&gt;&gt;</span>) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    <span style=color:#66d9ef>case</span> Msg <span style=color:#66d9ef>of</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        <span style=color:#f92672>&lt;&lt;</span>Msg2:MsgSize<span style=color:#f92672>/</span>binary, _Rest<span style=color:#f92672>/</span>binary<span style=color:#f92672>&gt;&gt;</span> <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>            R <span style=color:#f92672>=</span> katja_echo_pb:<span style=color:#a6e22e>decode_riemannpb_msg</span>(Msg2),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>            {ok, R#riemannpb_msg{ok<span style=color:#f92672>=</span>true}};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>        _ <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>            {error, #riemannpb_msg{ok<span style=color:#f92672>=</span>false, error<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;Response could not be decoded&#34;</span>}}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    <span style=color:#66d9ef>end</span>;</span></span></code></pre></div></div><p><em>&#171;MsgSize:32/integer-big, Msg/binary></em> é um binary pattern match no qual diz que qualquer pacote que inicie com um inteiro de tamanho 32 bits (integer-big) seguido por um restante binary pode ser interpretado como uma mensagem riemann. Entretanto, apenas chamando a função
<em>katja_echo_pb:decode_riemannpb_msg/1</em>
vamos ter certeza se Msg contém ou não uma mensagem riemann.</p><p>Repare também que <em>MsgSize</em> serve para especificar o tamanho da variável <em>Msg2</em>. Isso é muito importante pois precisamos passar o tamanho correto da mensagem riemann.</p><p>Quando um cliente riemann envia um pacote TCP para o servidor, <a href=https://github.com/riemann/riemann-nodejs-client/blob/master/riemann/socket.js#L99>o mesmo coloca um valor int32 como sendo o tamanho da mensagem riemann</a>. Logo depois vem a mensagem riemann.</p><h2 id=events-riemann>Events riemann</h2><p>Relembrando, quando recebemos uma mensagem riemann do tipo Event, chamamos a função:</p><small>events
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_tcp.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>            ok <span style=color:#f92672>=</span> katja_echo:<span style=color:#a6e22e>events</span>(Cbk, Events),</span></span></code></pre></div></div><p>Com o argumento Events contento uma representação em termos Erlang de uma lista de eventos riemann.</p><p>No caso do katja_echo vamos armazenar todos os eventos em uma tabela <a href=https://erlang.org/doc/man/ets.html>ETS</a> para posterior consulta:</p><small>decode udp
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>do_events</span>(Events) <span style=color:#66d9ef>when</span> is_list(Events) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    _ <span style=color:#f92672>=</span> [insert_event(Event) || Event <span style=color:#f92672>&lt;-</span> Events],
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>    ok.
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#a6e22e>insert_event</span>(#riemannpb_event{host <span style=color:#f92672>=</span> H, service <span style=color:#f92672>=</span> S} <span style=color:#f92672>=</span> E) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    ets:<span style=color:#a6e22e>insert</span>(<span style=color:#f92672>?</span>TAB, {{H, S}, E});
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#a6e22e>insert_event</span>(#riemannpb_state{host <span style=color:#f92672>=</span> H, service <span style=color:#f92672>=</span> S} <span style=color:#f92672>=</span> E) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ets:<span style=color:#a6e22e>insert</span>(<span style=color:#f92672>?</span>TAB, {{H, S}, E}).</span></span></code></pre></div></div><p>A chave de cada linha na tabela vai ser uma tupla contento o nome do Host e o nome do Service: <em>#riemannpb_event{host = H, service = S}</em> e o valor é o evento integral.</p><p>Desta forma podemos fazer consultas via host e/ou service bem como aplicar <a href=https://erlang.org/doc/apps/erts/match_spec.html>match specification</a> para buscar eventos específicos.</p><h2 id=query-riemann>Query riemann</h2><p>Todos os eventos armazenados podem ser consultados usando simples queries. Exemplos:</p><ul><li><em>state = &ldquo;ok&rdquo;</em></li><li><em>metric_f > 2.0 and not host = nil</em></li><li><em>tagged &ldquo;product&rdquo;</em></li></ul><p>Geralmente cliente riemann possui uma API para fazer as consultas. Os dados retornados são todos os eventos riemann selecionados pela consulta.</p><p>O servidor riemann oficial implementa uma <a href=https://github.com/riemann/riemann/blob/master/resources/query.g4>gramática e parser para interpretar uma query</a>, katja_echo implementa uma gramática e parser baseados na implementação oficial mas usando uma aplicação disponível no OTP chamada <a href=https://erlang.org/doc/apps/parsetools/index.html>Parse Tools</a>.</p><p>Parse Tools possui duas ferramentas:</p><ul><li>yecc, no qual gera um parser LALR-1 usando uma gramática BNF</li><li>leex, um tokenizador baseado em expressões regulares</li></ul><div><aside class="callout dark-gray bg-washed-green"><div class=type><svg class="large-icon"><use xlink:href="/dist/images/icons.svg#sprite-callout-tip"/></svg></div><div class=content><p>Alguns links e tutoriais caso precise implementar algo similar:</p><ul><li><a href=https://andrealeopardi.com/posts/tokenizing-and-parsing-in-elixir-using-leex-and-yecc/>Tokenizing and parsing in Elixir with yecc and leex</a></li><li><a href=https://github.com/elixir-gettext/gettext/blob/e2e3d42edd2a8fa5aa2deada2e5779f122594e71/src/gettext_po_parser.yrl>Internationalization and localization support for Elixir</a></li><li><a href=http://web.archive.org/web/20170921125618/http://relops.com/blog/2014/01/13/leex_and_yecc/>Leex And Yecc</a></li><li><a href=https://github.com/relops/leex_yecc_example>A simple example of how to use Leex and Yecc</a></li><li><a href=https://notes.eellson.com/2017/01/22/html-parsing-in-elixir-with-leex-and-yecc/>HTML parsing in Elixir with leex and yecc</a></li><li><a href=https://cameronp.svbtle.com/how-to-use-leex-and-yecc>How to use leex and yecc in Elixir</a></li><li><a href=https://arjanvandergaag.nl/blog/write-your-own-parser.html>Writing a lexer and parser</a></li><li><a href=http://raol.io/post/parsing-with-leex-and-yecc/>Parsing with leex and yecc</a></li><li><a href=https://github.com/raol/ecalculator>Simple project to play with leex and yecc.</a></li></ul></div></aside></div><p>Dependendo do caso podemos usar outro tipo de tokenizador, não necessariamente precisamos usar o leex. Mas por conveniência iniciamos com a criação das regras do token como definido no arquivo <a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query_lexer.xrl>katja_echo_query_lexer.xr</a>.</p><p>Logo em seguida definimos as regras gramaticais <a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query_grammar.yrl>katja_echo_query_grammar.yrl</a>.</p><p>Com o tokenizer e a gramática, definimos um modulo e criamos algumas funções nas quais recebem uma string chamando o lexer e grammar para analisar:</p><small>parse
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>parse</span>(<span style=color:#f92672>&lt;&lt;</span>Bin<span style=color:#f92672>/</span>binary<span style=color:#f92672>&gt;&gt;</span>) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    parse(binary_to_list(Bin));
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#a6e22e>parse</span>(String) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    {ok, Tokens, _EndLine} <span style=color:#f92672>=</span> katja_echo_query_lexer:<span style=color:#a6e22e>string</span>(String),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    katja_echo_query_grammar:<span style=color:#a6e22e>parse</span>(Tokens).</span></span></code></pre></div></div><p>Expondo uma API para receber uma query, fazer a análise e baseado em uma árvore parseada realizar as operações da query recebida:</p><small>calling parse tree
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>do_query</span>({ok, ParseTree}) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    katja_echo_query:<span style=color:#66d9ef>query</span>(<span style=color:#f92672>?</span>TAB, ParseTree);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#a6e22e>do_query</span>({error, {_LineNumber, Module, Message}}) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    {error, {<span style=color:#e6db74>&#34;syntax error&#34;</span>, Module:<span style=color:#a6e22e>format_error</span>(Message)}};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span><span style=color:#a6e22e>do_query</span>(Query) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>    do_query(katja_echo_query:<span style=color:#a6e22e>parse</span>(Query)).</span></span></code></pre></div></div><p><em>ParseTree</em> contém termos Erlang nas quais outras funções irão processar e retornar os eventos:</p><small>getting data
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>qq</span>(_Tab, [], R) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    R;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#a6e22e>qq</span>(Tab, [{&#39;and&#39;, P} | Hs], R) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    {ok, Results} <span style=color:#f92672>=</span> do_query(Tab, make_match_conditions(&#39;andalso&#39;, Tab, P)),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    qq(Tab, Hs, Results <span style=color:#f92672>++</span> R);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#a6e22e>qq</span>(Tab, [{&#39;or&#39;, P} | Hs], R) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    {ok, Results} <span style=color:#f92672>=</span> do_query(Tab, make_match_conditions(&#39;orelse&#39;, Tab, P)),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    qq(Tab, Hs, Results <span style=color:#f92672>++</span> R);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#a6e22e>qq</span>(Tab, [{field, _, _, _} <span style=color:#f92672>=</span> P | [] <span style=color:#f92672>=</span> Hs], R) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {ok, Results} <span style=color:#f92672>=</span> do_query(Tab, make_match_conditions(&#39;andalso&#39;, Tab, P)),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    qq(Tab, Hs, Results <span style=color:#f92672>++</span> R);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span><span style=color:#a6e22e>qq</span>(Tab, [{field, _, _, _} <span style=color:#f92672>=</span> P | Hs], R) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    qq(Tab, Hs, make_match_conditions(&#39;andalso&#39;, Tab, P) <span style=color:#f92672>++</span> R);
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#a6e22e>qq</span>(Tab, [{field, _, _} <span style=color:#f92672>=</span> P | Hs], R) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>    qq(Tab, Hs, make_match_conditions(&#39;andalso&#39;, Tab, P) <span style=color:#f92672>++</span> R).</span></span></code></pre></div></div><p>Acima usamos pattern match e processamento com listas. Não existe uma forma padronizada de implementar tal código. O segredo é encontrar a melhor estrutura de dados que case com a necessidade.</p><p>Após todo o processamento da query, chega o momento de consultar a tabela ETS e obter os eventos. Fazemos isso usando uma feature do OTP chamada <a href=https://erlang.org/doc/apps/erts/match_spec.html>match specification</a>.</p><div><aside class="callout dark-gray bg-washed-green"><div class=type><svg class="large-icon"><use xlink:href="/dist/images/icons.svg#sprite-callout-tip"/></svg></div><div class=content>match specification pode assustar mas é muito poderosa e usado em várias partes do OTP. Recomendo sempre lembrar que existe antes de criar qualquer coisa semelhante.</div></aside></div><p>No nosso caso, com o resultado do parser da query apenas precisamos criar a parte chamada MatchConditions e enviar chamar a função
<a href=https://erlang.org/doc/man/ets.html#select-2 title=ets:select/2 target=_blank>ets:select/2</a>
.</p><small>getting data
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/src/katja_echo_query.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>do_query</span>(Tab, MatchConditions) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    MS <span style=color:#f92672>=</span> [{{&#39;_&#39;, &#39;$1&#39;}, MatchConditions, [&#39;$1&#39;]}],
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    {ok, ets:<span style=color:#a6e22e>select</span>(Tab, MS)}.</span></span></code></pre></div></div><p>A intenção de implementar uma interface para queries riemann foi justamente poder consultar os dados da tabela ETS sem precisar criar queries manuais, ou seja, match specifications são criados a partir da query recebida.</p><p>Um último ponto sobre este assunto é que a ferramenta rebar3 possui suporte para geração de código a partir dos arquivos yrl e xrl:</p><small>rebar yrl e xrl
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/rebar.config title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/rebar.config source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/rebar.config<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{yrl_opts, [{verbose, true}]}.
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>{xrl_opts, [{verbose, true}]}.</span></span></code></pre></div></div><h2 id=testes>Testes</h2><p>A estratégia de testes segue duas linhas principais sendo testes unitários e testes de integração.</p><p><a href=https://github.com/katja-beam/katja_echo/blob/master/test/katja_echo_SUITE.erl>katja_echo_SUITE.erl</a>, usando o framework Common Test e iniciando a aplicação katja_echo de forma controlada.</p><p>O importante é levar em conta a testabilidade durante o design da aplicação. Um exemplo clássico é utilizar callbacks nas quais podemos trocar quando em testes. Isso facilita verificar se o caso de teste está atingindo os postos necessários. Exemplo:</p><small>Changing callback
<a href=https://github.com/katja-beam/katja_echo/blob/0.1.1/test/katja_echo_SUITE.erl title="See https://github.com/katja-beam/katja_echo/blob/0.1.1/test/katja_echo_SUITE.erl source on GitHub" target=_blank>https://github.com/katja-beam/katja_echo/blob/0.1.1/test/katja_echo_SUITE.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>listen_tcp_events</span>(_Config) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    {ok, Ref, Fun} <span style=color:#f92672>=</span> reply_events(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Event <span style=color:#f92672>=</span> default_event(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    Events <span style=color:#f92672>=</span> default_event(<span style=color:#ae81ff>10</span>),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {ok, Pid} <span style=color:#f92672>=</span> katja_echo:<span style=color:#a6e22e>start_link</span>([{callback, Fun}]),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    ok <span style=color:#f92672>=</span> katja:<span style=color:#a6e22e>send_event</span>(katja_writer, tcp, Event),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    check_event(Ref, Event),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    ok <span style=color:#f92672>=</span> katja:<span style=color:#a6e22e>send_events</span>(katja_writer, tcp, Events),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    check_event(Ref, Events),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    katja_echo_sup:<span style=color:#a6e22e>stop</span>(Pid),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>    ok.</span></span></code></pre></div></div><p>Repare que a função
<em>reply_events()</em>
retorna uma tuple onde o terceiro elemento é uma função anônima na qual vai ser usada para configurar a callback.</p><p>Quando a callback for executada, dentro da aplicação katja_echo, podemos verificar chamando a função
<em>check_event/2</em>
.</p><p><a href=https://github.com/katja-beam/katja_echo/blob/master/test/katja_echo_query_tests.erl>katja_echo_query_tests</a>, usando o framework eunit e seguindo uma abordagem mais teste unitário onde definimos um <a href=http://erlang.org/doc/apps/eunit/chapter.html#Writing_test_generating_functions>gerador automático dos casos de teste</a> baseados em uma lista de queries. É um uso mais avançado do eunit e traz grande economia de tempo na escrita dos testes.</p><h2 id=conclusão>Conclusão</h2><p>As ideias e técnicas apresentadas neste artigo podem servir como inspiração para aqueles que precisam criar alguma solução similar. Principalmente para isolarem algum subsistema utilizado para testes. Ou reimplementarem algum outro protocolo ou servidor utilizando Erlang ou Elixir.</p><ul class=pa0><li class="list di"><a href=/tags/code/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">code</a></li><li class="list di"><a href=/tags/parser/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">parser</a></li><li class="list di"><a href=/tags/tcp/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">tcp</a></li><li class="list di"><a href=/tags/udp/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">udp</a></li><li class="list di"><a href=/tags/gen_statem/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">gen_statem</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">O que há neste posts</p><nav id=TableOfContents><ul><li><a href=#riemannio>riemann.io</a></li><li><a href=#o-protocolo-riemann>O protocolo riemann</a></li><li><a href=#servidor-udp>Servidor UDP</a></li><li><a href=#servidor-tcp>Servidor TCP</a></li><li><a href=#events-riemann>Events riemann</a></li><li><a href=#query-riemann>Query riemann</a></li><li><a href=#testes>Testes</a></li><li><a href=#conclusão>Conclusão</a></li></ul></nav></div><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Relacionado</p><ul class="pa0 list"><li class=mb2><a href=/posts/mignon-29/>Gamepad</a></li><li class=mb2><a href=/posts/mignon-25/>eclero, coletando métricas</a></li><li class=mb2><a href=/posts/mignon-33/>Barramentos</a></li><li class=mb2><a href=/posts/mignon-32/>Simuladores em Erlang</a></li><li class=mb2><a href=/posts/mignon-31/>Aplicações distribuídas com OTP</a></li><li class=mb2><a href=/posts/mignon-24/>Brincando com Erlang nodes: cloonix</a></li><li class=mb2><a href=/posts/mignon-23/>Brincando com Erlang nodes: epmd</a></li><li class=mb2><a href=/posts/mignon-22/>Brincando com Erlang nodes: embedded</a></li><li class=mb2><a href=/posts/mignon-20/>Brincando com Erlang nodes: eclero</a></li><li class=mb2><a href=/posts/mignon-21/>Gerenciamento out-of-band: SSH</a></li><li class=mb2><a href=/posts/mignon-17/>Gerenciamento out-of-band: SQL</a></li><li class=mb2><a href=/posts/mignon-16/>meta-erlang com LTTng</a></li><li class=mb2><a href=/posts/mignon-15/>Ativando traces usando LTTng</a></li><li class=mb2><a href=/posts/mignon-12/>Trace instrumentando o código com dbg</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://beam-mignon.netlify.app/>&copy; https://creativecommons.org/licenses/by/4.0/ 2022</a><div><div class=ananke-socials><a href=https://twitter.com/joaohf target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/joaohf/ target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jo%c3%a3o-henrique-freitas target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://beam-mignon.netlify.app/feed.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>