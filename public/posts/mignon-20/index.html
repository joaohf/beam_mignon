<!doctype html><html lang=pt-br><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Brincando com Erlang nodes: eclero | BEAM Mignon</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Este post faz parte de uma série de outros posts relacionados a como usar Erlang distribution protocol.
Vamos iniciar alguns trabalhos para explorar como desenvolver, testar e experimentar utilizando nodes Erlang e uma aplicação distribuída.
Na primeira parte dos trabalhos vou contar um pouco sobre o design, detalhes de implementação e testes. A intenção foi implementar uma aplicação simples mas que utilize diversos conceitos e recursos do ambiente podendo ser utilizada para futuras experimentações."><meta name=generator content="Hugo 0.105.0-DEV"><meta name=robots content="noindex, nofollow"><link rel=stylesheet href=/ananke/css/main.min.css><meta property="og:title" content="Brincando com Erlang nodes: eclero"><meta property="og:description" content="Este post faz parte de uma série de outros posts relacionados a como usar Erlang distribution protocol.
Vamos iniciar alguns trabalhos para explorar como desenvolver, testar e experimentar utilizando nodes Erlang e uma aplicação distribuída.
Na primeira parte dos trabalhos vou contar um pouco sobre o design, detalhes de implementação e testes. A intenção foi implementar uma aplicação simples mas que utilize diversos conceitos e recursos do ambiente podendo ser utilizada para futuras experimentações."><meta property="og:type" content="article"><meta property="og:url" content="https://beam-mignon.netlify.app/posts/mignon-20/"><meta property="og:image" content="https://beam-mignon.netlify.app/posts/mignon-20/screenshot_cover.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-12-05T22:43:50+02:00"><meta property="article:modified_time" content="2019-12-15T18:28:01+01:00"><meta property="og:see_also" content="https://beam-mignon.netlify.app/posts/mignon-24/"><meta property="og:see_also" content="https://beam-mignon.netlify.app/posts/mignon-23/"><meta property="og:see_also" content="https://beam-mignon.netlify.app/posts/mignon-22/"><meta itemprop=name content="Brincando com Erlang nodes: eclero"><meta itemprop=description content="Este post faz parte de uma série de outros posts relacionados a como usar Erlang distribution protocol.
Vamos iniciar alguns trabalhos para explorar como desenvolver, testar e experimentar utilizando nodes Erlang e uma aplicação distribuída.
Na primeira parte dos trabalhos vou contar um pouco sobre o design, detalhes de implementação e testes. A intenção foi implementar uma aplicação simples mas que utilize diversos conceitos e recursos do ambiente podendo ser utilizada para futuras experimentações."><meta itemprop=datePublished content="2019-12-05T22:43:50+02:00"><meta itemprop=dateModified content="2019-12-15T18:28:01+01:00"><meta itemprop=wordCount content="2338"><meta itemprop=image content="https://beam-mignon.netlify.app/posts/mignon-20/screenshot_cover.png"><meta itemprop=keywords content="code,failure,eclero,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://beam-mignon.netlify.app/posts/mignon-20/screenshot_cover.png"><meta name=twitter:title content="Brincando com Erlang nodes: eclero"><meta name=twitter:description content="Este post faz parte de uma série de outros posts relacionados a como usar Erlang distribution protocol.
Vamos iniciar alguns trabalhos para explorar como desenvolver, testar e experimentar utilizando nodes Erlang e uma aplicação distribuída.
Na primeira parte dos trabalhos vou contar um pouco sobre o design, detalhes de implementação e testes. A intenção foi implementar uma aplicação simples mas que utilize diversos conceitos e recursos do ambiente podendo ser utilizada para futuras experimentações."></head><body class="ma0 avenir bg-near-white"><header class="cover bg-top" style=background-image:url(https://beam-mignon.netlify.app/images/featured/eclero-0-0.jpg)><div class=bg-black-60><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l justify-between items-center center"><a href=/ class="f3 fw2 hover-white no-underline white-90 dib">BEAM Mignon</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/contact/ title="Contato page">Contato</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/posts/ title="Posts page">Posts</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/reference/ title="Referencias page">Referencias</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white no-underline white-90" href=/about/ title="Sobre page">Sobre</a></li></ul><div class=ananke-socials><a href=https://twitter.com/joaohf target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/joaohf/ target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jo%c3%a3o-henrique-freitas target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://beam-mignon.netlify.app/feed.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></nav><div class="tc-l pv6 ph3 ph4-ns"><h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Brincando com Erlang nodes: eclero</h1></div></div></header><main class=pb7 role=main><article class="flex-l flex-wrap justify-between mw8 center ph3"><header class="mt4 w-100"><aside class="instapaper_ignoref b helvetica tracked">POSTS</aside><div id=sharing class="mt3 ananke-socials"><a href="https://twitter.com/share?url=https://beam-mignon.netlify.app/posts/mignon-20/&text=Brincando%20com%20Erlang%20nodes:%20eclero" class="ananke-social-link twitter no-underline" aria-label="share on Twitter"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https://beam-mignon.netlify.app/posts/mignon-20/&title=Brincando%20com%20Erlang%20nodes:%20eclero" class="ananke-social-link linkedin no-underline" aria-label="share on LinkedIn"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div><h1 class="f1 athelas mt3 mb1">Brincando com Erlang nodes: eclero</h1><time class="f6 mv4 dib tracked" datetime=2019-12-05T22:43:50+02:00>dezembro 5, 2019</time>
<span class="f6 mv4 dib tracked">- 11 minutes read</span>
<span class="f6 mv4 dib tracked">- 2338 words</span></header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Este post faz parte de uma série de outros posts relacionados a como usar <em>Erlang distribution protocol</em>.</p><p>Vamos iniciar alguns trabalhos para explorar como desenvolver, testar e experimentar utilizando nodes Erlang e uma aplicação distribuída.</p><p>Na primeira parte dos trabalhos vou contar um pouco sobre o design, detalhes de implementação e testes. A intenção foi implementar uma aplicação simples mas que utilize diversos conceitos e recursos do ambiente podendo ser utilizada para futuras experimentações.</p><p>O objetivo da aplicação é receber um request HTTP na qual deve responder com sucesso caso todos os nós do ambiente estejam operacionais. Caso algum nó da solução esteja indisponível a aplicação deve retornar um erro com o respectivo HTTP status code.</p><p>Alguns cenários de exemplos:</p><div class="dt dt--fixed w-100"><div class="dtc br"><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/20_003_hu834ec6e4a920a2004bb1159d9eb965c0_16280_500x400_fit_box_3.png width=335 height=315><figcaption><small><p>1: Nós operacionais.</p></small></figcaption></figure></div><div class="dtc br"><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/20_004_hu7733d00d7e9df882bc97648abe84b245_15844_500x400_fit_box_3.png width=335 height=315><figcaption><small><p>2: Nós em falha.</p></small></figcaption></figure></div><div class="dtc br"><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/20_005_hu1ab388e6687d4e2473734b150f713f51_13206_500x400_fit_box_3.png width=335 height=255><figcaption><small><p>3: Nós em falha.</p></small></figcaption></figure></div></div><ol><li>Com todos os nós operacionais as requests HTTP são respondidas com <a href=https://httpstatuses.com/200>code status 200 OK</a></li><li>Caso um nó entre em falha, as requests retornam <a href=https://httpstatuses.com/503>code status 503 Service Unavailable</a></li><li>Mais nós em falha.</li></ol><p>A aplicação foi nomeada de &rsquo;eclero&rsquo; por falta de um nome melhor. E a implementação foi feita em Erlang/OTP. É importante ressaltar que o único motivo de utiizar Erlang neste projeto foi para usar o framework de testes chamado common_test. Poderia ter utilizado Elixir e os resultados seriam os mesmos.</p><p>Todo o código fonte foi disponibilizado aqui: <a href=https://www.github.com/joaohf/eclero>joaohf/eclero</a>.</p><p>Antes de desmembrar o projeto é importante definirmos alguns requisitos (funcionais e não funcionais):</p><ol><li>Cada nó necessita detectar e ser notificado de qualquer falha dos outros nós</li><li>O cluster de nós Erlang deve ser configurado utilizando algum tipo de configuração vinda do ambiente</li><li>O ambiente de execução é Linux</li><li>Desejável poder rodar em um ambiente embarcado com o mínimo de recursos necessários</li><li>Mínimo de 3 nós para a solução funcionar</li></ol><h2 id=design-geral>Design geral</h2><p>O deployment da solução vai ocorrer em um ambiente simulado contendo no mínimo 3 nós Erlang e cada nó com uma instância da aplicação eclero:</p><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/20_001_hua4d7adc462b84efd78db208da7667dfb_6387_500x400_fit_box_3.png width=439 height=120><figcaption><small><p>3 nós no ambiente.</p></small></figcaption></figure><p>A aplicação eclero possui as seguintes responsabilidades:</p><ul><li>detectar se algum nó falhou</li><li>decidir se o cluster está em um estado consistente</li><li>prover uma interface HTTP</li></ul><p>Para isso vamos dividir a aplicação nos seguintes blocos:</p><ul><li><code>detector</code>, responsável por detectar se algum nó falhou</li><li><code>decision</code>, recebe eventos de <em>node up</em> e <em>node down</em> vindas do detector, e decide se o cluster está saudável (health) ou não</li><li><code>health</code>, cliente utilizando Erlang RPC para consultar o estado de saúde de todos os nós</li><li><code>int_http</code>, interface HTTP exportando alguns endpoints para consulta.</li></ul><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/20_006_huabd9479d42da1f8707f983b76a7ae002_6940_500x400_fit_box_3.png width=208 height=268><figcaption><small><p>Blocos internos da aplicação.</p></small></figcaption></figure><p>O código fonte foi organizado seguindo a estrutura OTP com os seguintes módulos no diretório <em>src</em>:</p><ul><li>eclero_app, implementa o behaviour <em>application</em></li><li>eclero_sup, supervisor principal da aplicação</li><li>eclero_decision_server: <em>gen_server</em> para o bloco decision</li><li>eclero_detector_server: <em>gen_server</em> para receber eventos do detector de falhas (aten)</li><li>eclero_detector: behaviour para facilitar testes e possível troca de detector</li><li>eclero_health: cliente utilizando Erlang RPC</li><li>eclero_http: implementa as callbacks necessárias para a interface HTTP</li></ul><div><aside class="callout dark-gray bg-washed-green"><div class=type><svg class="large-icon"><use xlink:href="/dist/images/icons.svg#sprite-callout-tip"/></svg></div><div class=content><p>Visite estes dois links para relembrar sobre o OTP:</p><ul><li><a href=https://learnyousomeerlang.com/what-is-otp>What is OTP?</a></li><li><a href=https://erlang.org/doc/design_principles/users_guide.html>Open Telecom Platform</a></li></ul></div></aside></div><p>eclero_sup é um supervisor no qual possui dois workers sob seu comando: eclero_decision_server e eclero_detector_server.</p><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/20_hua33aa443924bf42fb29bacc08d708597_19313_500x400_fit_box_3.png width=500 height=210><figcaption><small><p>Árvore de supervisao do eclero.</p></small></figcaption></figure><p>Todos os testes foram implementados utilizando common_test e estão contidos no diretório <em>test</em>.</p><p>Já para gestão de build, a ferramenta escolhida foi o rebar3 utilizando dois plugins:</p><ul><li><a href=https://github.com/project-fifo/rebar3_lint>rebar3_lint</a>, para chamar o <a href=https://github.com/inaka/elvis>elvis</a> e fazer uma checagem de melhores práticas</li><li><a href=https://github.com/markusn/coveralls-erl>coveralls</a>, para enviar o resultados de cobertura dos testes para o serviço coveralls.io</li></ul><p>Neste projeto, rebar3 é utilizado para:</p><ul><li>gestão de dependências</li><li>compilação</li><li>execução dos testes</li><li>geração de release</li></ul><p>O arquivo <a href=https://github.com/joaohf/eclero/blob/master/rebar.config>rebar.config</a> possui todas as configurações feitas.</p><div><aside class="callout mid-gray bg-light-gray"><div class=type><svg class="large-icon"><use xlink:href="/dist/images/icons.svg#sprite-callout-note"/></svg></div><div class=content>Recomendo olhar a documentação oficial do rebar3 pois sempre há algum parâmetro útil.</div></aside></div><p>Também configuramos um CI (Continuous Integration) apenas para fazer uma checagem e executar os testes a cada commit. Utilizamos o serviço travis-ci integrado com o github. Toda a configuração foi feita no arquivo <a href=https://github.com/joaohf/eclero/blob/master/.travis.yml>travis.yml</a>.</p><h2 id=implementação>Implementação</h2><div><aside class="callout mid-gray bg-light-gray"><div class=type><svg class="large-icon"><use xlink:href="/dist/images/icons.svg#sprite-callout-note"/></svg></div><div class=content><p>Recomendo revisar os conceitos de behaviour bem como a nomemclatura utilizada. Consulte esta referência para mais detalhes:</p><ul><li><a href=http://erlang.org/doc/design_principles/des_princ.html#behaviours>OTP design principles: Behaviours</a></li></ul></div></aside></div><h3 id=detector-de-falhas>Detector de falhas</h3><p>O módulo eclero_detector_server foi implementado utilizando um gen_server. Na callback de inicialização registramos os nós que temos interesse em sermos notificados quando algum evento ocorre:</p><small>Inicialização do decision server.
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>init</span>(_Args) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    process_flag(trap_exit, true),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    Nodes <span style=color:#f92672>=</span> application:<span style=color:#a6e22e>get_env</span>(eclero, nodes, []),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    Module <span style=color:#f92672>=</span> application:<span style=color:#a6e22e>get_env</span>(eclero, detector_module, eclero_detector),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    {ok, #state{detector_module <span style=color:#f92672>=</span> Module}, {continue, {register, Nodes}}}.
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#a6e22e>handle_continue</span>({register, RNodes}, #state{detector_module <span style=color:#f92672>=</span> DM,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                                           nodes <span style=color:#f92672>=</span> Nodes} <span style=color:#f92672>=</span> State) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {ok, INodes} <span style=color:#f92672>=</span> register_interest(DM, RNodes, Nodes),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>    {noreply, State#state{nodes <span style=color:#f92672>=</span> INodes}, {continue, up}};</span></span></code></pre></div></div><p>A callback <code>register_interest/3</code> é um wrapper para as funções do aten. Estamos usando uma aplicação chamada <a href=https://github.com/rabbitmq/aten>aten</a> na qual implementa o algorítimo utilizado para detectar se algum nó está vivo ou não.</p><p>Um ponto interessante é que a callback <code>init/1</code> obtem as configurações do ambiente, inicializa o estado a aplicação e depois retorna uma tupla contendo o atom &lsquo;continue&rsquo;. Isso vai fazer com que o gen_server execute a callback <code>handle_continue/2</code> e continue a inicialização do gen_server.</p><p>Quando há qualquer mudança no estado dos nós, aten envia uma mensagem para o processo local registrado como eclero_detector_server. Então devemos implementar a callback <code>handle_info/2</code> para tratar este tipo de mensagem. Caso contrário o server irá descartar estas mensagens importantes.</p><small>Tratando mensagens de up e down
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>handle_info</span>({node_event, Node, Event}, #state{nodes <span style=color:#f92672>=</span> Nodes} <span style=color:#f92672>=</span> State) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    Nodes0 <span style=color:#f92672>=</span> update_interest(Nodes, Node, Event),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    ok <span style=color:#f92672>=</span> eclero_decision_server:<span style=color:#a6e22e>node_status</span>(Node, Event),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    {noreply, State#state{nodes <span style=color:#f92672>=</span> Nodes0}}.</span></span></code></pre></div></div><p>Com o evento e o nome do nó, avisamos o eclero_decision_server no qual vai tomar a decisão e registrar a informação do evento.</p><p>Também implementamos a callback <code>terminate/2</code> para desregistrar o monitoramento do nó feito pelo aten.</p><small>Tratando mensagens de up e down
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_detector_server.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>terminate</span>(_Reason, #state{detector_module <span style=color:#f92672>=</span> DM, nodes <span style=color:#f92672>=</span> Nodes}) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    deregister_interest(DM, Nodes),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    ok.</span></span></code></pre></div></div><h3 id=servidor-de-decisão>Servidor de decisão</h3><p>Já no módulo eclero_decision_server a principal responsabilidade é responder se o cluster está operacional ou não. O requisito principal é apenas responder se um cluster está operacional se todos os nós estão operacionais.</p><p>Um ponto interessante é que o record state possui a quantidade de nós em estado up e down, bem como um <code>set</code> (<a href=http://erlang.org/doc/man/sets.html>sets</a>) com todos os nós que participal do cluster:</p><small>record state
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>-record(state, {nodes_up <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> :: non_neg_integer(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>                nodes_down <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> :: non_neg_integer(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>                nodes <span style=color:#f92672>=</span> sets:<span style=color:#a6e22e>new</span>() :: sets:<span style=color:#a6e22e>set</span>(atom())}).</span></span></code></pre></div></div><p>As funções do módulo sets são chamadas na callback <code>handle_cast/3</code> para adicionar ou remover os nós:</p><small>Adicionar e remover nós
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>handle_cast</span>({node_status, Node, down}, #state{nodes_up <span style=color:#f92672>=</span> Up,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>                                              nodes_down <span style=color:#f92672>=</span> Down,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>                                              nodes <span style=color:#f92672>=</span> Nodes} <span style=color:#f92672>=</span> State) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>    {noreply, State#state{nodes_up <span style=color:#f92672>=</span> decrease(Up),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>                          nodes_down <span style=color:#f92672>=</span> Down <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>                          nodes <span style=color:#f92672>=</span> sets:<span style=color:#a6e22e>del_element</span>(Node, Nodes)}};
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#a6e22e>handle_cast</span>({node_status, Node, up}, #state{nodes_up <span style=color:#f92672>=</span> Up,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                                            nodes_down <span style=color:#f92672>=</span> Down,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                                            nodes <span style=color:#f92672>=</span> Nodes} <span style=color:#f92672>=</span> State) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {noreply, State#state{nodes_up <span style=color:#f92672>=</span> Up <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>                          nodes_down <span style=color:#f92672>=</span> decrease(Down),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>                          nodes <span style=color:#f92672>=</span> sets:<span style=color:#a6e22e>add_element</span>(Node, Nodes)}}.</span></span></code></pre></div></div><p>Algumas APIs são exportadas por este módulo para consultar o estado de saúde do cluster. Em especial, a API is_health/0 e is_health/1 mostram dois comportamentos:</p><small>APIs para consultar o estado do cluster
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_decision_server.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>is_health</span>() <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    gen_server:<span style=color:#a6e22e>call</span>(<span style=color:#f92672>?</span>MODULE, {is_health}).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#a6e22e>is_health</span>(Nodes) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    gen_server:<span style=color:#a6e22e>multi_call</span>(Nodes, <span style=color:#f92672>?</span>MODULE, {is_health}).</span></span></code></pre></div></div><p>A função <code>is_health/1</code>, aceita uma lista dos nós passando para a função <code>gen_server:multi_call/3</code> na qual faz uma chamada RPC para todos os nós e aguarda o retorno dos resultados.</p><p>Já quando chamada com arity 0, ou seja <code>is_health/0</code>, o nó local responde a chamada.</p><h3 id=health-api>Health API</h3><p>eclero utiliza uma interface HTTP para responder as requests vindas. Mas o protocolo HTTP, neste caso, é apenas uma interface para alguma API interna da aplicação.</p><p>O módulo eclero_health exporta uma API (<code>get/0</code>) mais simples para a interface HTTP usar, coletando a resposta de todos os nós e retornando as respostas.</p><small>Interface simplificada
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_health.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_health.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_health.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>get() <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    {ok, Nodes} <span style=color:#f92672>=</span> eclero_decision_server:nodes(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    {Replies, _BadNodes} <span style=color:#f92672>=</span> eclero_decision_server:<span style=color:#a6e22e>is_health</span>(Nodes),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    {ok, Replies}.</span></span></code></pre></div></div><h3 id=interface-http>Interface HTTP</h3><p>E finalmente temos a interface HTTP implementada no módulo eclero_http, no qual implementamos algumas callbacks necessárias para o <a href=https://github.com/ninenines/cowboy>cowboy</a> funcionar.</p><p>Quando há alguma request HTTP, o primeiro passo é verificar se o cluster está operacional. cowboy disponibiliza a callback <code>service_available/2</code> na qual vamos para perguntar ao decision server se está tudo Ok.</p><small>Verifica se o cluster está Ok
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>service_available</span>(Req, State) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    Res <span style=color:#f92672>=</span> eclero_decision_server:<span style=color:#a6e22e>is_health</span>(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    {Res, Req, State}.</span></span></code></pre></div></div><p>Caso a função <code>eclero_decision_server:is_health/0</code> retorne true, a request vai prosseguir.</p><p>O próximo passo da request é processar a request. Isso é feito na função <code>to_text/2</code>:</p><small>Testando a conversão to_text
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>to_text</span>(Req, State) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    Body <span style=color:#f92672>=</span> to_text(eclero_health:get()),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    {Body, Req, State}.</span></span></code></pre></div></div><p><code>eclero_health:get/0</code> vai obter e retornar a resposta de todos os nós do cluster e a função <code>to_text/1</code> transformar a resposta em texto.</p><p>Adicionei um pequeno test unitário para a função privada <code>to_text/1</code>, utilizando <a href=http://erlang.org/doc/apps/eunit/chapter.html>eunit</a>:</p><small>Interface HTTP
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_http.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>to_text</span>({ok, Results}) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    Fun <span style=color:#f92672>=</span> <span style=color:#66d9ef>fun</span>({Node, Value}, AccIn) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        L <span style=color:#f92672>=</span> io_lib:<span style=color:#a6e22e>format</span>(<span style=color:#e6db74>&#34;</span><span style=color:#e6db74>~s</span><span style=color:#e6db74>:</span><span style=color:#e6db74>~w</span><span style=color:#e6db74>&#34;</span>, [Node, Value]),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>        [L | AccIn]
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    <span style=color:#66d9ef>end</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    L0 <span style=color:#f92672>=</span> lists:<span style=color:#a6e22e>foldl</span>(Fun, [], Results),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    L1 <span style=color:#f92672>=</span> lists:<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;,&#34;</span>, L0),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    list_to_binary(L1).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>-ifdef(TEST).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>-include_lib(<span style=color:#e6db74>&#34;eunit/include/eunit.hrl&#34;</span>).
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#a6e22e>to_text_test</span>() <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    L <span style=color:#f92672>=</span> to_text({ok, [{a, true}, {b, false}]}),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#f92672>?</span>assertEqual(<span style=color:#f92672>&lt;&lt;</span><span style=color:#e6db74>&#34;b:false,a:true&#34;</span><span style=color:#f92672>&gt;&gt;</span>, L),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    ok.
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>-endif.</span></span></code></pre></div></div><p>Queria ter certeza que a conversão está funcionando. Desta forma, com eunit, posso testar uma função privada.</p><h3 id=aplicação-e-supervisor>Aplicação e Supervisor</h3><p>E por fim o módulo eclero_app com algumas callbacks necessárias pedidas pelo behaviour application.</p><p>Na função <code>start/2</code>, obtemos a configuração da porta HTTP e iniciamos a interface HTTP. Logo após iniciamos o supervisor.</p><small>start da aplicação
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_app.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_app.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_app.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>start</span>(_StartType, _StartArgs) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    Port <span style=color:#f92672>=</span> application:<span style=color:#a6e22e>get_env</span>(eclero, http, <span style=color:#ae81ff>8000</span>),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    ok <span style=color:#f92672>=</span> eclero_http:<span style=color:#a6e22e>start</span>(Port),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    eclero_sup:<span style=color:#a6e22e>start_link</span>().</span></span></code></pre></div></div><p>Já na função <code>stop/1</code>, primeiro paramos a interface HTTP (para não responder nenhuma request a mais) e retornamos.</p><small>stop da aplicação
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_app.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_app.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_app.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#a6e22e>stop</span>(_State) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    ok <span style=color:#f92672>=</span> eclero_http:<span style=color:#a6e22e>stop</span>(),
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    ok.</span></span></code></pre></div></div><p>O módulo eclero_sup contem a criação da árvore de supervisão.</p><small>stop da aplicação
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_sup.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_sup.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/src/eclero_sup.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>init</span>([]) <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    SupFlags <span style=color:#f92672>=</span> #{strategy <span style=color:#f92672>=&gt;</span> one_for_all,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>                 intensity <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>                 period <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>5</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>    Decision <span style=color:#f92672>=</span> #{id <span style=color:#f92672>=&gt;</span> eclero_decision_server,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>                 start <span style=color:#f92672>=&gt;</span> {eclero_decision_server, start_link, []},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                 shutdown <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>5000</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    Detector <span style=color:#f92672>=</span> #{id <span style=color:#f92672>=&gt;</span> eclero_detector_server,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>                 start <span style=color:#f92672>=&gt;</span> {eclero_detector_server, start_link, []},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>                 shutdown <span style=color:#f92672>=&gt;</span> <span style=color:#ae81ff>5000</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    ChildSpecs <span style=color:#f92672>=</span> [Decision, Detector],
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>    {ok, {SupFlags, ChildSpecs}}.</span></span></code></pre></div></div><h2 id=testes-unitários>Testes unitários</h2><p>Não optei por utilizar testes unitários para testar o código da aplicação. Apenas usei o eunit para fazer um pequeno teste em um dos módulos.</p><p>A estratégia de testes adotada é algo mais sistêmica utilizando uma abordagem mais de fora para dentro.</p><h2 id=testes-funcionais>Testes funcionais</h2><p>Todos os testes foram implementados utilizando o framework <a href=https://erlang.org/doc/apps/common_test/introduction.html>common test</a>. Cada arquivo implementa uma suite de testes com uma certa organização dos casos de testes, funções de setup e teardown do ambiente.</p><p>A implementação do testes foi feita em apenas um arquivo: <em>apps/eclero/test/eclero_SUITE.erl</em> e alguns grupos de casos de testes foram definidos:</p><ul><li>system: utilizando o módulo <a href=https://erlang.org/doc/man/ct_slave.html>ct_slave</a> para criação de nós Erlang adicionais, podemos testar como a aplicação eclero quando há mais de um nó</li><li>decision: queremos apenas testar o server, o resto da aplicação não é inicializada</li><li>detector: quermoes apenas testar o server, o resto da aplicação não é inicializada</li></ul><small>stop da aplicação
<a href=https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/test/eclero_SUITE.erl title="See https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/test/eclero_SUITE.erl source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/apps/eclero/test/eclero_SUITE.erl<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#a6e22e>groups</span>() <span style=color:#f92672>-&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>    [
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>        {system, [], [
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>                      {start_stop, [sequence], start_stop()},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>                      {missing_nodes, [sequence], missing_nodes()},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>                      {normal, [sequence], dist_tests()}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>                     ]},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>        {decision, [sequence], decision_tests()},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>        {detector, [sequence], detector_tests()}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    ].</span></span></code></pre></div></div><p>Quando executamos os testes do grupo <code>system</code>, cada teste irá executar num ambiente como o descrito na figura abaixo:</p><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/20_002_hu1d044d7ccbfe846625c8eb7a6116e5e7_14886_500x400_fit_box_3.png width=329 height=346><figcaption><small><p>Nó common_test e System Under Test.</p></small></figcaption></figure><p>O nó ct apenas estimula, ou seja, chama as funções ou faz requests para o cluster. Enquanto outros nós estão executando a aplicação eclero e todas as suas dependências.</p><p>Em geral, common test é um framework bastante poderoso e exige organização dos testes para não virar uma grande confusão. Algumas dicas:</p><ul><li>estruturar os testes por blocos funcionais organizando em grupos lógicos</li><li>iniciar pelo grupo lógico no qual consiga testar o máximo de elementos com o mínimo de código</li><li>utilizar as funções <code>init_per_group/1</code> e <code>end_per_group/0</code>, <code>init_per_testcase/1</code> e <code>end_per_testcase/1</code> para fazer o setup e teardown dos grupos e casos de teste</li><li>não é necessário utilizar asserts para averiguar o resultado esperado. Usando apenas pattern match é possível verificar as expectativas</li><li>caso deseje falhar algum testes, use as funções do ct. Exemplo: <code>ct:fail/1</code></li><li>utilize as funções de logs quando necessário. Exemplo <code>ct:pal/1</code></li><li>use os resultados dos relatórios de coverage e também dos logs de testes para guiar os próximos passos</li></ul><p>Para executar os testes e também extrair as informaçoes de coverage, configuramos o rebar3 da seguinte forma:</p><small>Configuração para habilitar o coverage automático
<a href=https://github.com/joaohf/eclero/blob/mignon-20/rebar.config title="See https://github.com/joaohf/eclero/blob/mignon-20/rebar.config source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/rebar.config<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{cover_enabled, true}.</span></span></code></pre></div></div><p>Assim quando executamos os comando abaixo, podemos acessar os relatórios.</p><ul><li><code>rebar3 ct</code>: _build/test/logs/index.html</li></ul><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/screenshot_ct_huf27fa17315afc94dd2a8b79c3e9ebb8a_116088_640x480_fit_box_3.png width=640 height=360><figcaption><small><p>Relatório do common test</p></small></figcaption></figure><ul><li><code>rebar3 cover</code>: _build/test/cover/index.html</li></ul><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/screenshot_cover_huf4502956c8a373bae320c03836eb27ad_105478_640x480_fit_box_3.png width=640 height=360><figcaption><small><p>Relatório de coverage</p></small></figcaption></figure><p>Para facilitar, criei um alias com os seguintes comandos:</p><small>Configuração para habilitar o coverage automático
<a href=https://github.com/joaohf/eclero/blob/mignon-20/rebar.config title="See https://github.com/joaohf/eclero/blob/mignon-20/rebar.config source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/rebar.config<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{alias, [
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>    {check, [xref,
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>             {eunit, <span style=color:#e6db74>&#34;-c&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>             {ct, <span style=color:#e6db74>&#34;-c&#34;</span>},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>             {cover, <span style=color:#e6db74>&#34;-v --min_coverage=80&#34;</span>}]}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>]}.</span></span></code></pre></div></div><p>Assim posso executar <code>rebar3 check</code> e realizar todos os testes e análises necessárias.</p><h2 id=testes-locais>Testes locais</h2><p>Queremos também poder executar a aplicação localmente para algum teste específico. Utilizando rebar3 é possível configurar um shell com a aplicação inicializada para podermos exercitar alguns comandos.</p><p>Adicionamos a seguinte configuração no arquivo rebar.config para iniciar um shell configurado como um nó.</p><small>Configuração para habilitar distribution node
<a href=https://github.com/joaohf/eclero/blob/mignon-20/rebar.config title="See https://github.com/joaohf/eclero/blob/mignon-20/rebar.config source on GitHub" target=_blank>https://github.com/joaohf/eclero/blob/mignon-20/rebar.config<i class=icon-github></i></a></small><div class=codewrapper><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-erlang data-lang=erlang><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>{dist_node, [
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>        {setcookie, &#39;eclero&#39;},
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>        {sname, &#39;eclero0&#39;}
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>]}.</span></span></code></pre></div></div><p>E para executar a aplicação: <code>rebar3 shell</code></p><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/screenshot_shell_hu8688938d1f4744f76ad6e0e87a8e8e5d_72049_640x480_fit_box_3.png width=640 height=360><figcaption><small><p>Relatório de coverage</p></small></figcaption></figure><p>Agora é uma boa hora para chamarmos o observer e visualizar alguns outros detalhes</p><figure class="center bg-light-gray tc"><img class="center pt1" style=max-width:100%;width:auto;height:auto src=/posts/mignon-20/screenshot_observer_hud3b97aa9338ac3fe958b3132d402c288_95424_640x480_fit_box_3.png width=640 height=360><figcaption><small><p>Relatório de coverage</p></small></figcaption></figure><p>Com a aplicação executando, podemos enviar uma request e ver o resultado:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span>$ curl -v http://localhost:8000/check
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span>*   Trying 127.0.0.1...
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span>* TCP_NODELAY set
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span>* Connected to localhost <span style=color:#f92672>(</span>127.0.0.1<span style=color:#f92672>)</span> port <span style=color:#ae81ff>8000</span> <span style=color:#f92672>(</span><span style=color:#75715e>#0)</span>
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>&gt; GET /check HTTP/1.1
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>&gt; Host: localhost:8000
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>&gt; User-Agent: curl/7.58.0
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>&gt; Accept: */*
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>&gt;
</span></span><span style=display:flex;background-color:#3c3d38><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>&lt; HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>&lt; content-length: <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>&lt; content-type: text/plain
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>&lt; date: Mon, <span style=color:#ae81ff>16</span> Dec <span style=color:#ae81ff>2019</span> 20:40:37 GMT
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>&lt; server: Cowboy
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>&lt;
</span></span><span style=display:flex><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>* Connection <span style=color:#75715e>#0 to host localhost left intact</span></span></span></code></pre></div><h2 id=conclusão>Conclusão</h2><p>Neste post, analisamos alguns aspectos da implementação da aplicação eclero. Foi uma navegada rápida nos principais pontos que julguei necessários.</p><p>Nos próximos posts vamos continuar a explorar como integrar e executar o eclero em um ambiente simulado e analisar o comportamento da solução.</p><ul class=pa0><li class="list di"><a href=/tags/code/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">code</a></li><li class="list di"><a href=/tags/failure/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">failure</a></li><li class="list di"><a href=/tags/eclero/ class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">eclero</a></li></ul><div class="mt6 instapaper_ignoref"></div></div><aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">O que há neste posts</p><nav id=TableOfContents><ul><li><a href=#design-geral>Design geral</a></li><li><a href=#implementação>Implementação</a><ul><li><a href=#detector-de-falhas>Detector de falhas</a></li><li><a href=#servidor-de-decisão>Servidor de decisão</a></li><li><a href=#health-api>Health API</a></li><li><a href=#interface-http>Interface HTTP</a></li><li><a href=#aplicação-e-supervisor>Aplicação e Supervisor</a></li></ul></li><li><a href=#testes-unitários>Testes unitários</a></li><li><a href=#testes-funcionais>Testes funcionais</a></li><li><a href=#testes-locais>Testes locais</a></li><li><a href=#conclusão>Conclusão</a></li></ul></nav></div><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links"><p class="f5 b mb3">Relacionado</p><ul class="pa0 list"><li class=mb2><a href=/posts/mignon-24/>Brincando com Erlang nodes: cloonix</a></li><li class=mb2><a href=/posts/mignon-23/>Brincando com Erlang nodes: epmd</a></li><li class=mb2><a href=/posts/mignon-22/>Brincando com Erlang nodes: embedded</a></li><li class=mb2><a href=/posts/mignon-21/>Gerenciamento out-of-band: SSH</a></li><li class=mb2><a href=/posts/mignon-17/>Gerenciamento out-of-band: SQL</a></li><li class=mb2><a href=/posts/mignon-16/>meta-erlang com LTTng</a></li><li class=mb2><a href=/posts/mignon-15/>Ativando traces usando LTTng</a></li><li class=mb2><a href=/posts/mignon-12/>Trace instrumentando o código com dbg</a></li><li class=mb2><a href=/posts/mignon-33/>Barramentos</a></li><li class=mb2><a href=/posts/mignon-32/>Simuladores em Erlang</a></li><li class=mb2><a href=/posts/mignon-31/>Aplicações distribuídas com OTP</a></li><li class=mb2><a href=/posts/mignon-29/>Gamepad</a></li><li class=mb2><a href=/posts/mignon-26/>riemann echo</a></li><li class=mb2><a href=/posts/mignon-25/>eclero, coletando métricas</a></li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://beam-mignon.netlify.app/>&copy; https://creativecommons.org/licenses/by/4.0/ 2022</a><div><div class=ananke-socials><a href=https://twitter.com/joaohf target=_blank class="twitter ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel=noopener aria-label="follow on Twitter——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 67 67" viewBox="0 0 67 67" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167 22.283c-2.619.953-4.274 3.411-4.086 6.101l.063 1.038-1.048-.127c-3.813-.487-7.145-2.139-9.974-4.915l-1.383-1.377-.356 1.017c-.754 2.267-.272 4.661 1.299 6.271.838.89.649 1.017-.796.487-.503-.169-.943-.296-.985-.233-.146.149.356 2.076.754 2.839.545 1.06 1.655 2.097 2.871 2.712l1.027.487-1.215.021c-1.173.0-1.215.021-1.089.467.419 1.377 2.074 2.839 3.918 3.475l1.299.444-1.131.678c-1.676.976-3.646 1.526-5.616 1.568C19.775 43.256 19 43.341 19 43.405c0 .211 2.557 1.397 4.044 1.864 4.463 1.377 9.765.783 13.746-1.568 2.829-1.673 5.657-5 6.978-8.221.713-1.716 1.425-4.851 1.425-6.354.0-.975.063-1.102 1.236-2.267.692-.678 1.341-1.419 1.467-1.631.21-.403.188-.403-.88-.043-1.781.636-2.033.551-1.152-.402.649-.678 1.425-1.907 1.425-2.267.0-.063-.314.042-.671.233-.377.212-1.215.53-1.844.72l-1.131.361-1.027-.7c-.566-.381-1.361-.805-1.781-.932C39.766 21.902 38.131 21.944 37.167 22.283zM33 64C16.432 64 3 50.569 3 34S16.432 4 33 4s30 13.431 30 30S49.568 64 33 64z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://github.com/joaohf/ target=_blank class="github ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="GitHub link" rel=noopener aria-label="follow on GitHub——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M256 32C132.3 32 32 134.8 32 261.7c0 101.5 64.2 187.5 153.2 217.9 11.2 2.1 15.3-5 15.3-11.1.0-5.5-.2-19.9-.3-39.1-62.3 13.9-75.5-30.8-75.5-30.8-10.2-26.5-24.9-33.6-24.9-33.6-20.3-14.3 1.5-14 1.5-14 22.5 1.6 34.3 23.7 34.3 23.7 20 35.1 52.4 25 65.2 19.1 2-14.8 7.8-25 14.2-30.7-49.7-5.8-102-25.5-102-113.5.0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8.0.0 18.8-6.2 61.6 23.5 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 42.8-29.7 61.5-23.5 61.5-23.5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6.0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5.0 30.7-.3 55.5-.3 63 0 6.1 4 13.3 15.4 11C415.9 449.1 480 363.1 480 261.7 480 134.8 379.7 32 256 32z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://www.linkedin.com/in/jo%c3%a3o-henrique-freitas target=_blank class="linkedin ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel=noopener aria-label="follow on LinkedIn——Opens in a new window"><span class=icon><svg style="enable-background:new 0 0 65 65" viewBox="0 0 65 65" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M50.837 48.137V36.425c0-6.275-3.35-9.195-7.816-9.195-3.604.0-5.219 1.983-6.119 3.374V27.71h-6.79c.09 1.917.0 20.427.0 20.427h6.79V36.729c0-.609.044-1.219.224-1.655.49-1.22 1.607-2.483 3.482-2.483 2.458.0 3.44 1.873 3.44 4.618v10.929H50.837zM22.959 24.922c2.367.0 3.842-1.57 3.842-3.531-.044-2.003-1.475-3.528-3.797-3.528s-3.841 1.524-3.841 3.528c0 1.961 1.474 3.531 3.753 3.531H22.959zM34 64C17.432 64 4 50.568 4 34 4 17.431 17.432 4 34 4s30 13.431 30 30c0 16.568-13.432 30-30 30zM26.354 48.137V27.71h-6.789v20.427h6.789z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a><a href=https://beam-mignon.netlify.app/feed.xml target=_blank class="rss ananke-social-link link-transition stackoverflow link dib z-999 pt3 pt0-l mr1" title="RSS link" rel=noopener aria-label="follow on RSS——Opens in a new window"><span class=icon><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path id="scale" d="M4 4.44v2.83c7.03.0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9.0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg></span><span class=new-window><svg height="8" style="enable-background:new 0 0 1000 1000" viewBox="0 0 1e3 1e3" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M598 128h298v298h-86V274L392 692l-60-60 418-418H598v-86zM810 810V512h86v298c0 46-40 86-86 86H214c-48 0-86-40-86-86V214c0-46 38-86 86-86h298v86H214v596h596z" style="fill-rule:evenodd;clip-rule:evenodd"/></svg></span></a></div></div></div></footer></body></html>